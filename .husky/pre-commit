# Detectar qu√© apps tienen cambios
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Dashboard: tsc, lint --fix, format
if echo "$CHANGED_FILES" | grep -q "^apps/dashboard/"; then
  echo "üîç Ejecutando checks de dashboard..."
  cd apps/dashboard
  # Ejecutar tsc pero ignorar errores de node_modules (tipos de terceros)
  TSC_OUTPUT=$(yarn tsc --noEmit --skipLibCheck 2>&1) || TSC_EXIT=$?
  # Filtrar errores de node_modules
  FILTERED_ERRORS=$(echo "$TSC_OUTPUT" | grep -v "node_modules" || true)
  # Solo fallar si hay errores que NO son de node_modules
  if [ -n "$FILTERED_ERRORS" ] && echo "$FILTERED_ERRORS" | grep -q "error TS"; then
    echo "‚ùå Errores de TypeScript encontrados:"
    echo "$FILTERED_ERRORS"
    exit 1
  fi
  yarn lint --fix || true
  yarn format
  git add .
  cd ../..
fi

# Website: format, lint-staged
if echo "$CHANGED_FILES" | grep -q "^apps/website/"; then
  echo "üîç Ejecutando checks de website..."
  cd apps/website
  yarn format
  yarn lint-staged
  if ! git diff --cached --quiet; then
    git add .
  fi
  cd ../..
fi

# Strapi: lint-staged
if echo "$CHANGED_FILES" | grep -q "^apps/strapi/"; then
  echo "üîç Ejecutando checks de strapi..."
  cd apps/strapi
  yarn lint-staged
  cd ../..
fi
